name: WASM Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@1.88.0
      with:
        targets: wasm32-unknown-unknown

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Build WASM
      working-directory: crates/iris-wasm
      run: bash scripts/build-wasm.sh

    - name: Test Guard
      working-directory: crates/iris-wasm
      run: npx tsx scripts/test-guard.ts

    - name: Test typescript
      working-directory: crates/iris-wasm
      run: npx --no-install --yes -p typescript tsc --noEmit pkg/iris_wasm.guard.ts

    - name: Validate npm package
      working-directory: crates/iris-wasm/pkg
      run: npm pack --dry-run
